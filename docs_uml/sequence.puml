@startuml
!theme mars

actor User
participant "Frontend\n(Next.js)" as FE
participant "Smart Contract\n(Staking)" as SC
participant "Backend API\n(Flask)" as API
participant "Celery Worker" as Worker
participant "Chainlink Oracle" as Oracle
database "MongoDB" as DB
participant "Notifications" as Notif

== Phase 1: Staking ==
User -> FE: Stake 1000 DAI
FE -> SC: approve(DAI) + stake(1000)
SC -> SC: Lock DAI\nMint position NFT
SC --> FE: Event: StakeCreated
FE -> API: POST /stakes (metadata)
API -> DB: Store stake record
API --> FE: Confirmation

== Phase 2: Rewards Calculation (pÃ©riodique) ==
Worker -> SC: Read active stakes
Worker -> Oracle: Fetch APY factors\n(volatility, price)
Oracle --> Worker: Current metrics
Worker -> Worker: Calculate dynamic rewards
Worker -> DB: Update user rewards
Worker -> API: Check notification rules

== Phase 3: Notification ==
API -> Notif: APY boost detected
Notif --> User: Push/Email alert

== Phase 4: Unstaking ==
User -> FE: Unstake position
FE -> SC: unstake(positionId)
SC -> SC: Transfer DAI + rewards\nBurn position NFT
SC --> FE: Event: Unstaked
FE -> API: POST /unstakes
API -> DB: Archive stake

@enduml